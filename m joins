
-- Drop old database if exists and create new
DROP DATABASE lab_assignment3;
CREATE DATABASE lab_assignment3;
USE lab_assignment3;

-- ---------- SCHEMA SETUP ----------
CREATE TABLE Student (
    student_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(50),
    department VARCHAR(30),
    marks DECIMAL(5,2)
);

CREATE TABLE Course (
    course_id INT AUTO_INCREMENT PRIMARY KEY,
    course_name VARCHAR(50),
    credits INT
);

CREATE TABLE Enrollment (
    enroll_id INT AUTO_INCREMENT PRIMARY KEY,
    student_id INT,
    course_id INT,
    enroll_date DATE DEFAULT CURRENT_DATE,
    FOREIGN KEY (student_id) REFERENCES Student(student_id),
    FOREIGN KEY (course_id) REFERENCES Course(course_id)
);

-- ---------- SAMPLE DATA ----------
INSERT INTO Student (first_name, department, marks) VALUES
('Amit','CSE',88.5),
('Riya','IT',76.0),
('John','ECE',91.0),
('Sneha','CSE',68.5),
('Karan','MECH',80.0);

INSERT INTO Course (course_name, credits) VALUES
('Database Systems',4),
('Operating Systems',3),
('AI Fundamentals',4),
('Computer Networks',3);

INSERT INTO Enrollment (student_id, course_id) VALUES
(1,1),(1,4),(2,3),(3,2),(4,1),(5,4);

-- ---------- SHOW INITIAL DATA ----------
SELECT * FROM Student;
SELECT * FROM Course;
SELECT * FROM Enrollment;

-- 10+ SQL QUERIES ‚Äì JOINS, SUBQUERIES, VIEWS

-- 1Ô∏è‚É£ INNER JOIN ‚Äì Students with their Courses
SELECT s.first_name, c.course_name, c.credits
FROM Student s
INNER JOIN Enrollment e ON s.student_id = e.student_id
INNER JOIN Course c ON e.course_id = c.course_id;

-- 2Ô∏è‚É£ LEFT JOIN ‚Äì All Students, even if not enrolled
SELECT s.first_name, c.course_name
FROM Student s
LEFT JOIN Enrollment e ON s.student_id = e.student_id
LEFT JOIN Course c ON e.course_id = c.course_id;

-- 3Ô∏è‚É£ RIGHT JOIN ‚Äì All Courses, even if no student enrolled
SELECT s.first_name, c.course_name
FROM Student s
RIGHT JOIN Enrollment e ON s.student_id = e.student_id
RIGHT JOIN Course c ON e.course_id = c.course_id;

-- 4Ô∏è‚É£ CROSS JOIN ‚Äì Cartesian combination (limited with WHERE)
SELECT s.first_name, c.course_name
FROM Student s
CROSS JOIN Course c
WHERE s.department = 'CSE';

-- 5Ô∏è‚É£ SELF JOIN ‚Äì Compare students within same department
SELECT a.first_name AS Student1, b.first_name AS Student2, a.department
FROM Student a
JOIN Student b
ON a.department = b.department AND a.student_id < b.student_id;

-- 6Ô∏è‚É£ SUBQUERY ‚Äì Students scoring above class average
SELECT first_name, marks
FROM Student
WHERE marks > (SELECT AVG(marks) FROM Student);

-- 7Ô∏è‚É£ SUBQUERY (IN operator) ‚Äì Students enrolled in AI course
SELECT first_name
FROM Student
WHERE student_id IN (
    SELECT e.student_id
    FROM Enrollment e
    JOIN Course c ON e.course_id = c.course_id
    WHERE c.course_name = 'AI Fundamentals'
);

-- 8Ô∏è‚É£ CORRELATED SUBQUERY ‚Äì Top student in each department
SELECT s1.first_name, s1.department, s1.marks
FROM Student s1
WHERE s1.marks = (
    SELECT MAX(s2.marks)
    FROM Student s2
    WHERE s2.department = s1.department
);

-- 9Ô∏è‚É£ SUBQUERY in FROM clause ‚Äì Department-wise average
SELECT department, ROUND(avg_marks,2)
FROM (
    SELECT department, AVG(marks) AS avg_marks
    FROM Student
    GROUP BY department
) AS dept_avg;

-- üîü VIEW ‚Äì Create a view for high scorers
DROP VIEW IF EXISTS HighScorers;
CREATE VIEW HighScorers AS
SELECT first_name, department, marks
FROM Student
WHERE marks > 80;

SELECT * FROM HighScorers;

-- 1Ô∏è‚É£1Ô∏è‚É£ VIEW + JOIN ‚Äì Combine student + course info
DROP VIEW IF EXISTS StudentCourseView;
CREATE VIEW StudentCourseView AS
SELECT s.first_name, s.department, c.course_name
FROM Student s
JOIN Enrollment e ON s.student_id = e.student_id
JOIN Course c ON e.course_id = c.course_id;

SELECT * FROM StudentCourseView;

-- 1Ô∏è‚É£2Ô∏è‚É£ UPDATE via VIEW (allowed in MySQL if single table)
UPDATE HighScorers
SET marks = marks + 2
WHERE department = 'CSE';

SELECT * FROM HighScorers;

-- ---------- CHECK ALL VIEWS ----------
SHOW FULL TABLES WHERE TABLE_TYPE='VIEW';
SELECT * FROM HighScorers;

/* ---------- CHECK ALL VIEWS ---------- */
SHOW FULL TABLES WHERE TABLE_TYPE LIKE 'VIEW';
